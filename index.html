<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Clinical Trial Eligibility</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f0f8ff; margin: 0; padding: 0; text-align: center; }
    .container { width: 90%; max-width: 500px; margin: 30px auto; padding: 20px; background-color: #ffffff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 12px; }
    h1, h2 { color: #007acc; margin-bottom: 20px; }
    label { display: block; margin-bottom: 5px; color: #333; text-align: left; font-weight: bold; }
    input, select, button, textarea { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
    button { background-color: #007acc; color: #fff; border: none; cursor: pointer; }
    button:hover { background-color: #005f99; }
    .page { display: none; } .visible { display: block; }
    .toggle-group { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
    .toggle-button { padding: 10px 20px; border: 1px solid #007acc; border-radius: 8px; background-color: #fff; color: #007acc; cursor: pointer; font-size: 16px; flex: 1 1 45%; max-width: 45%; }
    .toggle-button.selected { background-color: #007acc; color: #fff; }
    form { text-align: left; }
    .info-btn { background-color: #aaa; margin-top: -10px; margin-bottom: 15px; font-size: 14px; }
    .menu-container { display: flex; flex-direction: column; align-items: center; gap: 30px; margin-top: 40px; }
    .menu-item { width: 180px; height: 180px; border: 2px solid #ccc; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 18px; color: #333; cursor: pointer; }
    .menu-item:hover { background-color: #e6f0ff; }
    .trial-list button { width: 100%; margin-bottom: 10px; text-align: left; background-color: #e6f0ff; border: none; color: #007acc; font-size: 18px; }
    .trial-list button:hover { background-color: #cce0ff; }
    .trial-criteria { text-align: left; margin-top: 20px; color: #333; }
    .ok { color: #0b7a0b; font-weight: bold; }
    .no { color: #b30000; font-weight: bold; }
    .summary-list { text-align:left; padding-left:0; list-style:none; }
    .summary-list li { display: grid; grid-template-columns: 28px 1fr 90px 1fr; align-items: center; column-gap: 10px; margin-bottom: 8px; min-height: 28px; }
    .summary-list .study-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .summary-list .reason { color:#555; font-size: 13px; }
    .row-actions { display:flex; gap:6px; align-items:center; }
    .actions-bottom { display:flex; gap:10px; justify-content:space-between; }
    .small { font-size: 13px; color:#555; }
    .study-outcomes { display: grid; grid-template-columns: 1fr 140px; gap: 8px; align-items:center; }
    .study-outcomes .study-label { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  </style>
</head>
<body>
<div class="container">

  <!-- SCRIPT DI CONFIG E HELPER -->
  <script>
    const infoMessages = {
      weTrust: "", athena: "", hemorrhagic: "",
      librexia: "", vanish: "", pivotal: "", moste: "",
      twin2win2: "", artemis: "", hybernia: "", doneSymple: ""
    };

    // Link randomizzazione (opzionali)
    const randomizationLinks = {
      "ATHENA": "https://www.randomize.net/Randomize/Set.aspx?id=ba510dbb-ab7d-42ee-ae95-d8a46394d6ec&token=0d0bff39-455b-4f60-a95a-154476064f2e",
      "VANISH": "https://app.studyrandomizer.com/dashboard/",
      "MOSTE": "https://ecrf.chru-lille.fr/EnnovClinical/login?lang=EN",
      "TWIN-2-WIN 2": "https://www.studyrandomizer.com/",
      "DONE SYMPLE": "https://www.studyrandomizer.com/"
    };

    // === GOOGLE APPS SCRIPT CONFIG + HELPERS ===
    // SOSTITUISCI con il tuo URL /exec
    const GAS_URL = "PASTE_YOUR_WEB_APP_EXEC_URL_HERE";

    function sendToSheet(payload){
      try {
        const body = new URLSearchParams({ payload: JSON.stringify(payload) });
        fetch(GAS_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
          body
        });
      } catch(e) { console.warn("sendToSheet error:", e); }
    }

    // Colonne dei trial sullo Sheet
    const SHEET_TRIAL_KEYS = [
      "WeTrust","MARSS","ATHENA","VANISH","PIVOTAL","MOSTE","FASTEST","TICH3","LIBREXIA",
      "TWIN2WIN","ARTEMIS","HYBERNIA","DONESYMPLE"
    ];

    // Mappa nomi UI -> chiave colonna dello Sheet
    function buildTrialsForSheet(selectedStudies, studyOutcomes){
      const t = Object.fromEntries(SHEET_TRIAL_KEYS.map(k => [k, "no"]));
      const nameToKey = {
        "WeTrust":"WeTrust",
        "MARSS":"MARSS",
        "ATHENA":"ATHENA",
        "VANISH":"VANISH",
        "PIVOTAL":"PIVOTAL",
        "MOSTE":"MOSTE",
        "FASTEST":"FASTEST",
        "TICH-3":"TICH3",
        "Librexia":"LIBREXIA",
        "TWIN-2-WIN 2":"TWIN2WIN",
        "ARTEMIS":"ARTEMIS",
        "HYBERNIA":"HYBERNIA",
        "DONE SYMPLE":"DONESYMPLE"
      };
      (selectedStudies || []).forEach(displayName => {
        const key = nameToKey[displayName];
        if (!key) return;
        const outcome = studyOutcomes?.[displayName] || "intervention";
        t[key] = outcome; // "intervention" | "control"
      });
      return t;
    }
  </script>

  <!-- PAGE 1: Main Menu -->
  <div id="mainMenu" class="page visible">
    <h1>ENS-APP</h1>
    <div class="menu-container">
      <div class="menu-item" onclick="goToTrialsCriteria()">Trials Criteria</div>
      <div class="menu-item" onclick="goToNewPatient()">New Patient</div>
    </div>
  </div>

  <!-- PAGE 2: Trials List -->
  <div id="trialsList" class="page">
    <h1>Trials</h1>
    <div class="trial-list">
      <button onclick="showTrialCriteria('WeTrust')">WeTrust &gt;</button>
      <button onclick="showTrialCriteria('TICH3')">TICH-3 &gt;</button>
      <button onclick="showTrialCriteria('ATHENA')">ATHENA &gt;</button>
      <button onclick="showTrialCriteria('FASTEST')">FASTEST &gt;</button>
      <button onclick="showTrialCriteria('Librexia')">Librexia &gt;</button>
      <button onclick="showTrialCriteria('Vanish')">VANISH &gt;</button>
      <button onclick="showTrialCriteria('Pivotal')">PIVOTAL &gt;</button>
      <button onclick="showTrialCriteria('Moste')">MOSTE &gt;</button>
      <button onclick="showTrialCriteria('Twin2Win2')">TWIN-2-WIN 2 &gt;</button>
      <button onclick="showTrialCriteria('Artemis')">ARTEMIS &gt;</button>
      <button onclick="showTrialCriteria('Hybernia')">HYBERNIA &gt;</button>
      <button onclick="showTrialCriteria('DoneSymple')">DONE SYMPLE &gt;</button>
    </div>
    <button type="button" onclick="goBackToMain()">Back</button>
  </div>

  <!-- PAGE 3: Trial Detail -->
  <div id="trialDetail" class="page">
    <h1 id="trialTitle"></h1>
    <div class="trial-criteria" id="trialCriteriaText"></div>
    <button type="button" onclick="showPage('trialsList')">Back</button>
  </div>

  <!-- PAGE 4: Pre-Imaging -->
  <div id="preImaging" class="page">
    <h1>Pre-Imaging</h1>
    <form id="formPreImaging">
      <label for="age">Age</label>
      <input type="number" id="age" required>
      <label for="nihss">NIHSS</label>
      <input type="number" id="nihss" required>
      <label for="premrs">pre-mRS</label>
      <select id="premrs" required>
        <option value="0">0</option><option value="1">1</option><option value="2">2</option>
        <option value="3">3</option><option value="4">4</option><option value="5">5</option>
      </select>
      <label for="ltsw">Last Seen Well (Date & Time)</label>
      <input type="datetime-local" id="ltsw" required>
      <label for="angiograph">Philips angiograph available?</label>
      <select id="angiograph" required>
        <option value="yes">Yes</option><option value="no">No</option>
      </select>
      <button type="button" onclick="submitPreImaging()">Next</button>
    </form>
  </div>

  <!-- PAGE 5: Pre-Imaging Result -->
  <div id="preResult" class="page">
    <h1>Pre-Imaging</h1>
    <p id="weTrustResultMessage"></p>
    <button type="button" class="info-btn" onclick="showInfo('weTrust')" id="weTrustInfoBtn" style="display:none;">Info</button>
    <button type="button" onclick="openWeTrustRandomization()" id="weTrustRandomizeBtn" style="display:none;">Randomization</button>
    <button type="button" onclick="continueAfterWeTrust()">Next</button>
  </div>

  <!-- PAGE 6: Post-Imaging -->
  <div id="postImaging" class="page">
    <h1>Post-Imaging</h1>
    <div id="postExclusion" style="display:none;">
      <h2>Exclusion Criteria Detected</h2>
      <p id="exclusionMessage"></p>
      <button type="button" onclick="restart()">New Evaluation</button>
    </div>
    <div id="postImagingContent">
      <div>
        <label>Stroke Type</label>
        <div id="strokeTypeGroup" class="toggle-group">
          <button type="button" class="toggle-button" onclick="selectStrokeType('ischemic')">Ischemic</button>
          <button type="button" class="toggle-button" onclick="selectStrokeType('hemorrhagic')">Hemorrhagic</button>
        </div>
      </div>

      <!-- Ischemic branch -->
      <div id="ischemicSection" style="display:none;">
        <div id="candidateSection">
          <label>Candidate for thrombectomy?</label>
          <div id="candidateGroup" class="toggle-group">
            <button type="button" class="toggle-button" onclick="selectCandidate('not')">Not eligible</button>
            <button type="button" class="toggle-button" onclick="selectCandidate('eligible')">Eligible</button>
          </div>
        </div>
        <div id="evtSection" style="display:none;">
          <label>LVO</label>
          <select id="lvo" required>
            <option value="yes">Yes</option><option value="no">No</option>
          </select>
          <label>Vessel diameter (mm)</label>
          <input type="number" step="0.1" id="vesselDimension" required>
          <label>Tandem occlusion present?</label>
          <select id="tandem" required>
            <option value="no">No</option><option value="yes">Yes</option>
          </select>
          <label>Vessel tortuosity present?</label>
          <select id="tortuosity" required>
            <option value="no">No</option><option value="yes">Yes</option>
          </select>
          <label>Target vessel</label>
          <select id="targetVessel" required>
            <option value="ica-intracranial">Intracranial ICA</option>
            <option value="ica-terminal">Terminal ICA (ICA-T)</option>
            <option value="m1">M1</option>
            <option value="m2-proxdom">M2 proximal/dominant</option>
            <option value="m2-any">Any M2</option>
            <option value="basilar">Basilar artery</option>
            <option value="other">Other</option>
          </select>
          <label>Contraindications to thrombolysis?</label>
          <select id="contraTpa" required>
            <option value="no">No</option><option value="yes">Yes</option>
          </select>
          <label for="aspects">ASPECTS</label>
          <input type="number" id="aspects" min="0" max="10">
        </div>
      </div>

      <!-- Hemorrhagic branch -->
      <div id="hemorrhagicSection" style="display:none;">
        <h2>Hemorrhagic Study Questions</h2>
        <label>Hemorrhage Volume (mL)</label>
        <input type="number" step="0.1" id="hemVolume" required>
        <label>GCS</label>
        <input type="number" id="gcs" required>
        <label>Is the hemorrhage isolated to IVH only?</label>
        <div id="ivhGroup" class="toggle-group">
          <button type="button" class="toggle-button" onclick="selectHem('ivh','yes')">Yes</button>
          <button type="button" class="toggle-button" onclick="selectHem('ivh','no')">No</button>
        </div>
        <label>Secondary Cause</label>
        <select id="secondaryCause" required>
          <option value="None">None</option><option value="Traumatic">Traumatic</option>
          <option value="AVM">AVM</option><option value="Aneurysm">Aneurysm</option>
          <option value="Tumor">Tumor</option><option value="Other">Other</option>
        </select>
        <label>Active seizures / acute thrombosis / hypersensitivity to tranexamic acid present?</label>
        <div id="seizureGroup" class="toggle-group">
          <button type="button" class="toggle-button" onclick="selectHem('seizure','yes')">Yes</button>
          <button type="button" class="toggle-button" onclick="selectHem('seizure','no')">No</button>
        </div>
        <label>Anticoagulant therapy in use</label>
        <select id="anticoagulantTherapy" required>
          <option value="none">None</option><option value="warfarin">Warfarin</option>
          <option value="heparin">Heparin &lt;24h</option><option value="doac">DOAC</option>
        </select>

        <div id="fastestSection" style="display:none;">
          <h2>FASTEST Additional Questions</h2>
          <label>Brainstem hemorrhage?</label>
          <div id="brainstemGroup" class="toggle-group">
            <button type="button" class="toggle-button" onclick="selectHem('brainstem','yes')">Yes</button>
            <button type="button" class="toggle-button" onclick="selectHem('brainstem','no')">No</button>
          </div>
          <label>Procoagulant drugs used in last 24h?</label>
          <div id="procoagulantGroup" class="toggle-group">
            <button type="button" class="toggle-button" onclick="selectHem('procoagulant','yes')">Yes</button>
            <button type="button" class="toggle-button" onclick="selectHem('procoagulant','no')">No</button>
          </div>
          <label>ECG infarction or ST elevation?</label>
          <div id="ecgGroup" class="toggle-group">
            <button type="button" class="toggle-button" onclick="selectHem('ecg','yes')">Yes</button>
            <button type="button" class="toggle-button" onclick="selectHem('ecg','no')">No</button>
          </div>
          <label>Thrombosis in last 90 days?</label>
          <div id="thrombosisGroup" class="toggle-group">
            <button type="button" class="toggle-button" onclick="selectHem('thrombosis','yes')">Yes</button>
            <button type="button" class="toggle-button" onclick="selectHem('thrombosis','no')">No</button>
          </div>
          <label>Pregnancy or gestation?</label>
          <div id="pregnancyGroup" class="toggle-group">
            <button type="button" class="toggle-button" onclick="selectHem('pregnancy','yes')">Yes</button>
            <button type="button" class="toggle-button" onclick="selectHem('pregnancy','no')">No</button>
          </div>
          <label>Angioplasty or stenting in last 90 days?</label>
          <div id="angioplastyGroup" class="toggle-group">
            <button type="button" class="toggle-button" onclick="selectHem('angioplasty','yes')">Yes</button>
            <button type="button" class="toggle-button" onclick="selectHem('angioplasty','no')">No</button>
          </div>
          <label>IVH score acceptable?</label>
          <div id="ivhScoreGroup" class="toggle-group">
            <button type="button" class="toggle-button" onclick="selectHem('ivhScore','yes')">Yes</button>
            <button type="button" class="toggle-button" onclick="selectHem('ivhScore','no')">No</button>
          </div>
        </div>
      </div>

      <button type="button" onclick="submitPostImaging()">Next</button>
    </div>
  </div>

  <!-- PAGE 7: Post-Imaging Exclusion Page -->
  <div id="postExclusionPage" class="page">
    <h1>Exclusion Detected</h1>
    <p id="exclusionMessage"></p>
    <button type="button" onclick="restart()">New Evaluation</button>
  </div>

  <!-- PAGE 8: Ischemic Results -->
  <div id="marssAthenaResults" class="page">
    <h1>Ischemic Study Check</h1>
    <p id="athenaResult"></p>
    <p id="vanishResult"></p>
    <p id="pivotalResult"></p>
    <p id="mosteResult"></p>
    <p id="twin2winResult"></p>
    <p id="artemisResult"></p>
    <p id="hyberniaResult"></p>
    <p id="doneSympleResult"></p>
    <button type="button" class="info-btn" onclick="showInfo('athena')" id="athenaInfoBtn" style="display:none;">ATHENA Info</button>
    <button type="button" class="info-btn" onclick="showInfo('vanish')" id="vanishInfoBtn" style="display:none;">VANISH Info</button>
    <button type="button" class="info-btn" onclick="showInfo('pivotal')" id="pivotalInfoBtn" style="display:none;">PIVOTAL Info</button>
    <button type="button" class="info-btn" onclick="showInfo('moste')" id="mosteInfoBtn" style="display:none;">MOSTE Info</button>
    <button type="button" class="info-btn" onclick="showInfo('twin2win2')" id="twin2winInfoBtn" style="display:none;">TWIN-2-WIN 2 Info</button>
    <button type="button" class="info-btn" onclick="showInfo('artemis')" id="artemisInfoBtn" style="display:none;">ARTEMIS Info</button>
    <button type="button" class="info-btn" onclick="showInfo('hybernia')" id="hyberniaInfoBtn" style="display:none;">HYBERNIA Info</button>
    <button type="button" class="info-btn" onclick="showInfo('doneSymple')" id="doneSympleInfoBtn" style="display:none;">DONE SYMPLE Info</button>
    <button type="button" onclick="handleMarssAthena()">Next</button>
  </div>

  <!-- PAGE 9: Librexia (Milvexian) Questions -->
  <div id="librexiaPage" class="page">
    <h1>Librexia Study Questions</h1>
    <form id="formLibrexia">
      <label>Suspected atherothrombotic cause?</label>
      <div class="toggle-group">
        <button type="button" class="toggle-button" onclick="selectLix('suspect','yes')">Yes</button>
        <button type="button" class="toggle-button" onclick="selectLix('suspect','no')">No</button>
      </div>

      <label>Select at least one:</label>
      <div class="toggle-group">
        <button type="button" class="toggle-button" onclick="toggleLixCriterion('persistent')">Persistent symptoms</button>
        <button type="button" class="toggle-button" onclick="toggleLixCriterion('imaging')">Imaging lesion</button>
        <button type="button" class="toggle-button" onclick="toggleLixCriterion('treatment')">Thrombolysis/thrombectomy (after 24h, no hemorrhage)</button>
      </div>

      <label for="abcd2">ABCD2 score</label>
      <input type="number" id="abcd2" required>

      <label>Antiplatelet therapy in use or planned?</label>
      <div class="toggle-group">
        <button type="button" class="toggle-button" onclick="selectLix('anti','yes')">Yes</button>
        <button type="button" class="toggle-button" onclick="selectLix('anti','no')">No</button>
      </div>

      <label for="inr">INR</label>
      <input type="number" step="0.1" id="inr" required>

      <label for="aptt">aPTT</label>
      <input type="number" step="0.1" id="aptt" required>

      <label>Pregnant?</label>
      <div class="toggle-group">
        <button type="button" class="toggle-button" onclick="selectLix('pregnant','no')">No</button>
        <button type="button" class="toggle-button" onclick="selectLix('pregnant','yes')">Yes</button>
      </div>

      <label>History of intracranial bleeding?</label>
      <div class="toggle-group">
        <button type="button" class="toggle-button" onclick="selectLix('icb','no')">No</button>
        <button type="button" class="toggle-button" onclick="selectLix('icb','yes')">Yes</button>
      </div>

      <label>Chronic anticoagulation required?</label>
      <div class="toggle-group">
        <button type="button" class="toggle-button" onclick="selectLix('chronic','no')">No</button>
        <button type="button" class="toggle-button" onclick="selectLix('chronic','yes')">Yes</button>
      </div>

      <label>Bleeding risk disorders?</label>
      <div class="toggle-group">
        <button type="button" class="toggle-button" onclick="selectLix('bleed','no')">No</button>
        <button type="button" class="toggle-button" onclick="selectLix('bleed','yes')">Yes</button>
      </div>

      <label>Hepatic disease?</label>
      <div class="toggle-group">
        <button type="button" class="toggle-button" onclick="selectLix('hepatic','no')">No</button>
        <button type="button" class="toggle-button" onclick="selectLix('hepatic','yes')">Yes</button>
      </div>

      <label>Allergy to Milvexian excipients?</label>
      <div class="toggle-group">
        <button type="button" class="toggle-button" onclick="selectLix('allergy','no')">No</button>
        <button type="button" class="toggle-button" onclick="selectLix('allergy','yes')">Yes</button>
      </div>

      <label for="gfr">GFR (ml/min)</label>
      <input type="number" id="gfr" required>

      <label>Taking CYP3A4/P-gp inhibitors?</label>
      <div class="toggle-group">
        <button type="button" class="toggle-button" onclick="selectLix('inhibitors','no')">No</button>
        <button type="button" class="toggle-button" onclick="selectLix('inhibitors','yes')">Yes</button>
      </div>

      <label>ALT normal (≤3x normal)?</label>
      <div class="toggle-group">
        <button type="button" class="toggle-button" onclick="selectLix('alt','yes')">Yes</button>
        <button type="button" class="toggle-button" onclick="selectLix('alt','no')">No</button>
      </div>

      <label>Platelets adequate (≥75,000)?</label>
      <div class="toggle-group">
        <button type="button" class="toggle-button" onclick="selectLix('platelets','yes')">Yes</button>
        <button type="button" class="toggle-button" onclick="selectLix('platelets','no')">No</button>
      </div>

      <label>Bilirubin normal (&lt;1.5x normal)?</label>
      <div class="toggle-group">
        <button type="button" class="toggle-button" onclick="selectLix('bilirubin','yes')">Yes</button>
        <button type="button" class="toggle-button" onclick="selectLix('bilirubin','no')">No</button>
      </div>

      <label>Hemoglobin normal (≥8)?</label>
      <div class="toggle-group">
        <button type="button" class="toggle-button" onclick="selectLix('hb','yes')">Yes</button>
        <button type="button" class="toggle-button" onclick="selectLix('hb','no')">No</button>
      </div>

      <button type="button" onclick="submitLibrexia()">Next</button>
    </form>
  </div>

  <!-- PAGE 10: Librexia Result -->
  <div id="librexiaResult" class="page">
    <h1>Librexia Study Result</h1>
    <div id="lixResultMessage"></div>
    <button type="button" class="info-btn" onclick="showInfo('librexia')" id="librexiaInfoBtn" style="display:none;">Info</button>
    <button type="button" onclick="restart()">New Evaluation</button>
  </div>

  <!-- PAGE 11: Final Summary -->
  <div id="summaryPage" class="page">
    <h1>Summary</h1>
    <p class="small">Select one or more eligible studies to include in the patient summary. Study names remain clickable (when available) to open the randomization portal.</p>
    <ul id="summaryContent" class="summary-list"></ul>
    <div class="actions-bottom">
      <button type="button" onclick="proceedToShare()">Next</button>
      <button type="button" onclick="restart()">New Evaluation</button>
    </div>
  </div>

  <!-- PAGE 12: Patient Summary & Share -->
  <div id="sharePage" class="page">
    <h1>Patient Summary & Share</h1>
    <form id="shareForm">
      <label for="patientNumber">Numero di storia (patient number)</label>
      <input type="text" id="patientNumber" placeholder="es. 2025-00123" required>

      <label>Randomization outcome for each selected study</label>
      <div id="studyOutcomesContainer" class="study-outcomes"></div>

      <label>Message (preview)</label>
      <textarea id="shareMessage" rows="4" readonly></textarea>

      <button type="button" onclick="copyMessage()">Copy</button>
      <button type="button" onclick="shareWhatsApp()">Share via WhatsApp</button>
      <button type="button" onclick="saveToSheet()">Salva su Google Sheet</button>
      <button type="button" onclick="showPage('summaryPage')">Back</button>
    </form>
  </div>

  <!-- SCRIPT PRINCIPALE APP -->
  <script>
    let preData = {}, postData = {}, evtData = {}, hemData = {};
    let lixData = { criteria: {} };
    let eligibility = {
      weTrust:false, athena:false, fastest:false, tich3:false,
      librexia:false, vanish:false, pivotal:false, moste:false,
      twin2win2:false, artemis:false, hybernia:false, doneSymple:false
    };
    let selectedStudies = [];
    let studyOutcomes = {}; // { studyName: "intervention" | "control" }

    function showPage(id){ document.querySelectorAll('.page').forEach(p=>p.classList.remove('visible')); document.getElementById(id).classList.add('visible'); }
    function goToTrialsCriteria(){ showPage('trialsList'); }
    function goToNewPatient(){ showPage('preImaging'); }
    function goBackToMain(){ showPage('mainMenu'); }

    function showTrialCriteria(name){
      document.getElementById('trialTitle').innerText = name;
      document.getElementById('trialCriteriaText').innerHTML = trialCriteria[name] || "<p>No criteria found.</p>";
      showPage('trialDetail');
    }

    const trialCriteria = {
      "WeTrust": `<ul><li>Age ≥ 18 years</li><li>NIHSS ≥ 10</li><li>pre-mRS 0–2</li><li>Last Seen Well ≤ 6 hours</li><li>Philips angiograph available</li></ul>`,
      "TICH3": `<ul><li>Onset &lt; 4.5h</li><li>Hemorrhage volume &lt; 60 mL</li><li>Not isolated IVH</li><li>GCS ≥ 5</li><li>No acute venous thrombosis/hypersensitivity, etc.</li></ul>`,
      "ATHENA": `<ul><li>Age 22–85</li><li>NIHSS ≥ 8</li><li>pre-mRS 0–2</li><li>LTSW ≤ 24h</li><li>LVO = yes, tandem = no, tortuosity = no</li></ul>`,
      "FASTEST": `<ul><li>Age 18–80</li><li>Onset ≤ 2h</li><li>GCS ≥ 8</li><li>Hemorrhage volume 2–60 cc</li><li>Acceptable IVH score, no procoagulant drugs, etc.</li></ul>`,
      "Librexia": `<ul><li>Age ≥ 40 years</li><li>Within 48 hours from LTSW</li><li>Ischemic stroke with NIHSS ≤ 7 and suspected atherothrombotic cause</li><li>ABCD2 score ≥ 6 (if TIA)</li><li>INR ≤ 1.5, aPTT ≤ 1.4, not pregnant</li><li>Exclusions: pre-mRS ≥ 3, intracranial hemorrhage history, GFR &lt; 15, etc.</li></ul>`,
      "Vanish": `<ul><li>Age ≥ 18 years</li><li>pre-mRS 0–1</li><li>NIHSS ≥ 6</li><li>Target vessel: Terminal ICA (ICA-T) or M1</li><li>No contraindications to thrombolysis</li></ul>`,
      "Pivotal": `<ul><li>LTSW &lt; 8 hours</li><li>Age 18–80</li><li>pre-mRS 0–1</li><li>NIHSS ≥ 6</li><li>Occlusion: Terminal ICA (ICA-T), M1 (prox–distal) or Basilar artery</li></ul>`,
      "Moste": `<ul><li>LTSW &lt; 23 hours</li><li>pre-mRS 0–1</li><li>NIHSS &lt; 6</li><li>Occlusion: Terminal ICA (ICA-T), M1 or M2</li></ul>`,
      "Twin2Win2": `<ul><li>LTSW &lt; 24h</li><li>Age &gt;18</li><li>pre-mRS 0–2</li><li>NIHSS ≥ 6</li><li>Occlusion: Terminal ICA (ICA-T), M1 (distal included), Basilar artery</li></ul>`,
      "Artemis": `<ul><li>LTSW &lt; 24h</li><li>Age 18–85</li><li>pre-mRS 0–2</li><li>NIHSS 6–25</li><li>Occlusion: Intracranial ICA, M1, M2 proximal/dominant</li><li>ASPECTS &gt; 5</li></ul>`,
      "Hybernia": `<ul><li>LTSW &lt; 24h</li><li>Age 18–89</li><li>pre-mRS 0–1</li><li>NIHSS ≥ 6</li><li>Occlusion: Intracranial ICA, M1, Any M2</li><li>ASPECTS &gt; 4</li></ul>`,
      "DoneSymple": `<ul><li>Window 24–72h</li><li>Age 18–80</li><li>pre-mRS 0–1</li><li>NIHSS ≥ 8</li><li>Occlusion: any vessel</li></ul>`
    };

    /* PRE-IMAGING / WETRUST */
    function submitPreImaging() {
      preData.age = parseInt(document.getElementById('age').value);
      preData.nihss = parseInt(document.getElementById('nihss').value);
      preData.premrs = parseInt(document.getElementById('premrs').value);
      const ltswInput = document.getElementById('ltsw').value;
      if (!ltswInput) { alert("Please enter Last Seen Well time."); return; }
      const lastSeen = new Date(ltswInput), now = new Date();
      if (lastSeen > now) { alert("Last Seen Well time cannot be in the future."); return; }
      preData.ltsw = (now - lastSeen) / (1000 * 60 * 60);
      preData.angiograph = document.getElementById('angiograph').value;

      eligibility.weTrust = (preData.age >= 18 && preData.nihss >= 10 && preData.premrs <= 2 && preData.ltsw <= 6 && preData.angiograph === 'yes');

      let errors = [];
      if (preData.age < 18) errors.push("Age below 18");
      if (preData.nihss < 10) errors.push("NIHSS below 10");
      if (preData.premrs > 2) errors.push("pre-mRS above 2");
      if (preData.ltsw > 6) errors.push("Time since LTSW above 6h");
      if (preData.angiograph !== 'yes') errors.push("Philips angiograph not available");
      infoMessages.weTrust = errors.join(", ");

      document.getElementById('weTrustResultMessage').innerHTML = eligibility.weTrust ? "Eligible for WeTrust." : "Not eligible for WeTrust.";
      document.getElementById('weTrustInfoBtn').style.display = eligibility.weTrust ? "none" : "inline-block";
      document.getElementById('weTrustRandomizeBtn').style.display = eligibility.weTrust ? "inline-block" : "none";

      showPage('preResult');
    }
    function continueAfterWeTrust(){ showPage('postImaging'); }
    function openWeTrustRandomization(){ window.open('https://wetrust.eu1.phsdp.com/login', '_blank'); }

    /* POST-IMAGING */
    function selectStrokeType(value){
      postData.strokeType = value;
      document.querySelectorAll('#strokeTypeGroup .toggle-button').forEach(btn => btn.classList.remove('selected'));
      Array.from(document.querySelectorAll('#strokeTypeGroup .toggle-button')).find(b => b.textContent.trim().toLowerCase() === value).classList.add('selected');
      if (value === "ischemic") { document.getElementById("ischemicSection").style.display = 'block'; document.getElementById("hemorrhagicSection").style.display = 'none'; }
      else { document.getElementById("ischemicSection").style.display = 'none'; document.getElementById("hemorrhagicSection").style.display = 'block'; updateHemorrhagicSection(); }
    }

    function selectCandidate(value){
      postData.candidate = value;
      document.querySelectorAll('#candidateGroup .toggle-button').forEach(btn => btn.classList.remove('selected'));
      Array.from(document.querySelectorAll('#candidateGroup .toggle-button')).find(b => b.textContent.trim().toLowerCase().includes(value)).classList.add('selected');
      if (value === "eligible") document.getElementById("evtSection").style.display = 'block';
      else showPage('librexiaPage');
    }

    function selectHem(q, v){
      hemData[q] = v;
      const groups = { ivh:"ivhGroup", seizure:"seizureGroup", brainstem:"brainstemGroup", procoagulant:"procoagulantGroup", ecg:"ecgGroup", thrombosis:"thrombosisGroup", pregnancy:"pregnancyGroup", angioplasty:"angioplastyGroup", ivhScore:"ivhScoreGroup" };
      if (groups[q]) {
        document.querySelectorAll('#' + groups[q] + ' .toggle-button').forEach(btn => btn.classList.remove('selected'));
        Array.from(document.querySelectorAll('#' + groups[q] + ' .toggle-button')).find(b => b.textContent.trim().toLowerCase() === v).classList.add('selected');
      }
    }

    function updateHemorrhagicSection(){ document.getElementById("fastestSection").style.display = (preData.ltsw < 2 && preData.premrs <= 2) ? 'block' : 'none'; }
    function checkIschemicPreExclusions(){ return []; }

    function submitPostImaging(){
      if (!postData.strokeType) { alert("Please select a Stroke Type."); return; }

      if (postData.strokeType === "ischemic") {
        const exclusionErrors = checkIschemicPreExclusions();
        if (exclusionErrors.length) { document.getElementById('exclusionMessage').innerHTML = "Patient already has exclusion criteria: " + exclusionErrors.join(", "); showPage('postExclusionPage'); return; }
        if (!postData.candidate) { alert("Please select the candidate option for thrombectomy."); return; }

        if (postData.candidate === "eligible") {
          const lvo = document.getElementById('lvo').value;
          const vesselDimension = parseFloat(document.getElementById('vesselDimension').value);
          const tandem = document.getElementById('tandem').value;
          const tortuosity = document.getElementById('tortuosity').value;
          const targetVessel = document.getElementById('targetVessel').value;
          const contraTpa = document.getElementById('contraTpa').value;
          const aspects = parseInt(document.getElementById('aspects').value);

          const vanishVesselOk  = (targetVessel === "ica-terminal" || targetVessel === "m1");
          const pivotalVesselOk = (targetVessel === "ica-terminal" || targetVessel === "m1" || targetVessel === "basilar");
          const mosteVesselOk   = (targetVessel === "ica-terminal" || targetVessel === "m1" || targetVessel === "m2-any" || targetVessel === "m2-proxdom");
          const twinVesselOk    = (targetVessel === "ica-terminal" || targetVessel === "m1" || targetVessel === "basilar");
          const artemisVesselOk = (targetVessel === "ica-intracranial" || targetVessel === "ica-terminal" || targetVessel === "m1" || targetVessel === "m2-proxdom");
          const hyberniaVesselOk= (targetVessel === "ica-intracranial" || targetVessel === "ica-terminal" || targetVessel === "m1" || targetVessel === "m2-any" || targetVessel === "m2-proxdom");

          eligibility.athena     = (preData.age >= 22 && preData.age <= 85 && preData.nihss >= 8 && preData.premrs <= 2 && preData.ltsw <= 24 && lvo === "yes" && tandem === "no" && tortuosity === "no");
          eligibility.vanish     = (preData.age >= 18 && preData.premrs <= 1 && preData.nihss >= 6 && lvo === "yes" && vanishVesselOk && contraTpa === "no");
          eligibility.pivotal    = (preData.ltsw < 8 && preData.age >= 18 && preData.age <= 80 && preData.premrs <= 1 && preData.nihss >= 6 && lvo === "yes" && pivotalVesselOk);
          eligibility.moste      = (preData.ltsw < 23 && preData.premrs <= 1 && preData.nihss < 6 && lvo === "yes" && mosteVesselOk);
          eligibility.twin2win2  = (preData.ltsw < 24 && preData.age > 18 && preData.premrs <= 2 && preData.nihss >= 6 && lvo === "yes" && twinVesselOk);
          eligibility.artemis    = (preData.ltsw < 24 && preData.age >= 18 && preData.age <= 85 && preData.premrs <= 2 && preData.nihss >= 6 && preData.nihss <= 25 && lvo === "yes" && artemisVesselOk && !isNaN(aspects) && aspects > 5);
          eligibility.hybernia   = (preData.ltsw < 24 && preData.age >= 18 && preData.age <= 89 && preData.premrs <= 1 && preData.nihss >= 6 && lvo === "yes" && hyberniaVesselOk && !isNaN(aspects) && aspects > 4);
          eligibility.doneSymple = (preData.ltsw >= 24 && preData.ltsw <= 72 && preData.age >= 18 && preData.age <= 80 && preData.premrs <= 1 && preData.nihss >= 8 && lvo === "yes");

          // messaggi info...
          // (come nel tuo codice)
          document.getElementById('athenaResult').innerHTML     = eligibility.athena      ? "Eligible for ATHENA."       : "Not eligible for ATHENA.";
          document.getElementById('vanishResult').innerHTML     = eligibility.vanish      ? "Eligible for VANISH."       : "Not eligible for VANISH.";
          document.getElementById('pivotalResult').innerHTML    = eligibility.pivotal     ? "Eligible for PIVOTAL."      : "Not eligible for PIVOTAL.";
          document.getElementById('mosteResult').innerHTML      = eligibility.moste       ? "Eligible for MOSTE."        : "Not eligible for MOSTE.";
          document.getElementById('twin2winResult').innerHTML   = eligibility.twin2win2   ? "Eligible for TWIN-2-WIN 2." : "Not eligible for TWIN-2-WIN 2.";
          document.getElementById('artemisResult').innerHTML    = eligibility.artemis     ? "Eligible for ARTEMIS."      : "Not eligible for ARTEMIS.";
          document.getElementById('hyberniaResult').innerHTML   = eligibility.hybernia    ? "Eligible for HYBERNIA."     : "Not eligible for HYBERNIA.";
          document.getElementById('doneSympleResult').innerHTML = eligibility.doneSymple  ? "Eligible for DONE SYMPLE."  : "Not eligible for DONE SYMPLE.";

          document.getElementById('athenaInfoBtn').style.display     = eligibility.athena     ? "none" : "inline-block";
          document.getElementById('vanishInfoBtn').style.display     = eligibility.vanish     ? "none" : "inline-block";
          document.getElementById('pivotalInfoBtn').style.display    = eligibility.pivotal    ? "none" : "inline-block";
          document.getElementById('mosteInfoBtn').style.display      = eligibility.moste      ? "none" : "inline-block";
          document.getElementById('twin2winInfoBtn').style.display   = eligibility.twin2win2  ? "none" : "inline-block";
          document.getElementById('artemisInfoBtn').style.display    = eligibility.artemis    ? "none" : "inline-block";
          document.getElementById('hyberniaInfoBtn').style.display   = eligibility.hybernia   ? "none" : "inline-block";
          document.getElementById('doneSympleInfoBtn').style.display = eligibility.doneSymple ? "none" : "inline-block";

          showPage('marssAthenaResults');
          return;
        } else { showPage('librexiaPage'); return; }
      }

      if (postData.strokeType === "hemorrhagic") {
        const hemVolume = parseFloat(document.getElementById('hemVolume').value);
        const gcs = parseInt(document.getElementById('gcs').value);
        const secondaryCause = document.getElementById('secondaryCause').value;
        if (isNaN(hemVolume) || isNaN(gcs) || !hemData.ivh || !hemData.seizure) { alert("Please fill in all hemorrhagic study questions."); return; }

        let fastestEligible = false;
        if (preData.ltsw <= 2 && preData.premrs <= 2 && preData.age >= 18 && preData.age <= 80) {
          if (!hemData.brainstem || !hemData.procoagulant || !hemData.ecg || !hemData.thrombosis || !hemData.pregnancy || !hemData.angioplasty || !hemData.ivhScore) { alert("Please fill in all FASTEST additional questions."); return; }
          const anticoag = document.getElementById('anticoagulantTherapy').value;
          fastestEligible = (gcs >= 8 && hemVolume >= 2 && hemVolume < 60 && hemData.brainstem === "no" && hemData.procoagulant === "no" && hemData.ecg === "no" && hemData.thrombosis === "no" && hemData.pregnancy === "no" && hemData.angioplasty === "no" && hemData.ivhScore === "yes" && anticoag === "none");
        }
        const tich3Eligible = (preData.ltsw < 4.5 && hemVolume < 60 && hemData.ivh === "no" && gcs >= 5 && hemData.seizure === "no" && secondaryCause === "None");
        eligibility.fastest = fastestEligible; eligibility.tich3 = tich3Eligible;

        let hemorrErrors = [];
        if (preData.ltsw >= 4.5) hemorrErrors.push("Time since LTSW ≥4.5h");
        if (hemVolume >= 60) hemorrErrors.push("Hemorrhage volume ≥60 mL");
        if (gcs < 5) hemorrErrors.push("GCS <5");
        infoMessages.hemorrhagic = hemorrErrors.join(", ");

        showSummary();
      }
    }

    function handleMarssAthena(){
      if (eligibility.athena || eligibility.vanish || eligibility.pivotal || eligibility.moste ||
          eligibility.twin2win2 || eligibility.artemis || eligibility.hybernia || eligibility.doneSymple) showSummary();
      else showPage('librexiaPage');
    }

    /* LIBREXIA */
    function selectLix(field, value){
      lixData[field] = value;
      document.querySelectorAll('[onclick*="selectLix(\'' + field + '\'"]').forEach(btn => btn.classList.remove('selected'));
      const buttons = Array.from(document.querySelectorAll('[onclick*="selectLix(\'' + field + '\'"]'));
      const target = buttons.find(b => b.textContent.trim().toLowerCase() === value);
      if (target) target.classList.add('selected');
    }

    function toggleLixCriterion(crit){
      if (!lixData.criteria) lixData.criteria = {};
      lixData.criteria[crit] = !lixData.criteria[crit];
      const btn = Array.from(document.querySelectorAll('.toggle-group .toggle-button')).find(b => {
        const txt = b.textContent.trim().toLowerCase();
        if (crit === "persistent") return txt === "persistent symptoms";
        if (crit === "imaging") return txt === "imaging lesion";
        if (crit === "treatment") return txt === "thrombolysis/thrombectomy (after 24h, no hemorrhage)";
      });
      if (btn) btn.classList.toggle('selected');
    }

    function submitLibrexia(){
      let lixEligible = true, errors = [];
      if (preData.age < 40) errors.push("Age below 40");
      if (preData.ltsw > 48) errors.push("Time since LTSW > 48h");
      if (lixData.suspect !== "yes") errors.push("Atherothrombotic cause not suspected");
      if (preData.nihss > 7) errors.push("NIHSS > 7");
      if (!(lixData.criteria && (lixData.criteria.persistent || lixData.criteria.imaging || lixData.criteria.treatment))) errors.push("No clinical criterion met");
      const abcd2 = parseInt(document.getElementById('abcd2').value);
      if (isNaN(abcd2) || abcd2 < 6) errors.push("ABCD2 score <6");
      if (lixData.anti !== "yes") errors.push("Antiplatelet therapy not in use/planned");
      const inr = parseFloat(document.getElementById('inr').value); if (isNaN(inr) || inr > 1.5) errors.push("INR >1.5");
      const aptt = parseFloat(document.getElementById('aptt').value); if (isNaN(aptt) || aptt > 1.4) errors.push("aPTT >1.4");
      if (lixData.pregnant !== "no") errors.push("Patient is pregnant");
      if (preData.premrs >= 3) errors.push("pre-mRS ≥3");
      if (lixData.chronic === "yes") errors.push("Requires chronic anticoagulation");
      if (lixData.bleed === "yes") errors.push("Bleeding risk disorder present");
      if (lixData.hepatic === "yes") errors.push("Hepatic disease present");
      if (lixData.allergy === "yes") errors.push("Allergy to Milvexian excipients");
      const gfr = parseFloat(document.getElementById('gfr').value); if (isNaN(gfr) || gfr < 15) errors.push("GFR <15");
      if (lixData.inhibitors === "yes") errors.push("Taking CYP3A4/P-gp inhibitors");
      if (lixData.alt !== "yes") errors.push("ALT not normal");
      if (lixData.platelets !== "yes") errors.push("Platelets inadequate");
      if (lixData.bilirubin !== "yes") errors.push("Bilirubin abnormal");
      if (lixData.hb !== "yes") errors.push("Hemoglobin low");

      if (errors.length > 0) { lixEligible = false; infoMessages.librexia = errors.join(", "); }
      eligibility.librexia = lixEligible;

      document.getElementById('lixResultMessage').innerHTML = lixEligible ? "Eligible for Librexia (Milvexian)." : "Not eligible for Librexia (Milvexian).";
      document.getElementById('librexiaInfoBtn').style.display = lixEligible ? "none" : "inline-block";
      showSummary();
    }

    /* INFO + SUMMARY */
    function showInfo(key){ alert(infoMessages[key] || "No unmet criteria."); }

    function showSummary(){
      const items = [
        ["WeTrust",  eligibility.weTrust,  infoMessages.weTrust,  "weTrust"],
        ["ATHENA",   eligibility.athena,   infoMessages.athena,   "athena"],
        ["VANISH",   eligibility.vanish,   infoMessages.vanish,   "vanish"],
        ["PIVOTAL",  eligibility.pivotal,  infoMessages.pivotal,  "pivotal"],
        ["MOSTE",    eligibility.moste,    infoMessages.moste,    "moste"],
        ["TWIN-2-WIN 2", eligibility.twin2win2, infoMessages.twin2win2, "twin2win2"],
        ["ARTEMIS",  eligibility.artemis,  infoMessages.artemis,  "artemis"],
        ["HYBERNIA", eligibility.hybernia, infoMessages.hybernia, "hybernia"],
        ["DONE SYMPLE", eligibility.doneSymple, infoMessages.doneSymple, "doneSymple"],
        ["FASTEST",  eligibility.fastest,  infoMessages.hemorrhagic, "hemorrhagic"],
        ["TICH-3",   eligibility.tich3,    infoMessages.hemorrhagic, "hemorrhagic"],
        ["Librexia", eligibility.librexia, infoMessages.librexia, "librexia"]
      ];
      const ul = document.getElementById('summaryContent');
      ul.innerHTML = "";
      items.forEach(([name, ok, reason])=>{
        const link = randomizationLinks[name];
        const nameHtml = (ok && link) ? `<a class="study-name" href="${link}" target="_blank">${name}</a>` : `<span class="study-name">${name}</span>`;
        const checkboxHtml = ok ? `<input type="checkbox" class="study-checkbox" value="${name}" title="Select ${name}">` : `<input type="checkbox" disabled title="Not eligible">`;
        const li = document.createElement('li');
        li.innerHTML =
          `${checkboxHtml}` +
          `${nameHtml}` +
          `<span class="${ok ? 'ok' : 'no'}">${ok ? 'Eligible' : 'Not eligible'}</span>` +
          `${ok ? '' : (reason ? `<span class="reason">Reasons: ${reason}</span>` : `<span></span>`)}`;
        ul.appendChild(li);
      });
      showPage('summaryPage');
    }

    /* SHARE FLOW */
    function proceedToShare(){
      const checks = Array.from(document.querySelectorAll('.study-checkbox')).filter(c => c.checked).map(c => c.value);
      if (!checks.length) { alert("Please select at least one eligible study to include in the summary."); return; }
      selectedStudies = checks;
      studyOutcomes = {};
      selectedStudies.forEach(s => studyOutcomes[s] = "intervention");

      const container = document.getElementById('studyOutcomesContainer');
      container.innerHTML = "";
      selectedStudies.forEach(s => {
        const label = document.createElement('div');
        label.className = 'study-label';
        label.textContent = s;
        const sel = document.createElement('select');
        sel.className = 'outcome-select';
        sel.dataset.study = s;
        sel.innerHTML = `<option value="intervention">intervention</option><option value="control">control</option>`;
        sel.addEventListener('change', (e)=>{
          studyOutcomes[e.target.dataset.study] = e.target.value;
          buildShareMessage();
        });
        container.appendChild(label);
        container.appendChild(sel);
      });

      buildShareMessage();
      showPage('sharePage');
    }

    function buildShareMessage(){
      const pn = (document.getElementById('patientNumber')?.value || "").trim() || "Clinic history number";
      const lines = selectedStudies.map(study => {
        const outcome = studyOutcomes[study] || "intervention";
        return `${pn}, età ${isFinite(preData.age) ? preData.age : "?"}, NIHSS ${isFinite(preData.nihss) ? preData.nihss : "?"}, mRS ${isFinite(preData.premrs) ? preData.premrs : "?"}, ${study} (${outcome})`;
      });
      document.getElementById('shareMessage').value = lines.join('\n');
    }

    // === SALVATAGGIO SU GOOGLE SHEET (GLOBALE) ===
    function saveToSheet(){
      const Npatient = (document.getElementById('patientNumber')?.value || "").trim();
      if (!Npatient) { alert("Inserisci il Numero di storia (N patient) prima di salvare."); return; }
      if (typeof preData.age === "undefined" || typeof preData.nihss === "undefined" ||
          typeof preData.ltsw === "undefined" || typeof preData.premrs === "undefined") {
        alert("Compila prima Pre-Imaging (Age, NIHSS, LTSW, pre-mRS).");
        return;
      }
      const trialsForSheet = buildTrialsForSheet(selectedStudies, studyOutcomes);
      const payload = {
        N_patient: Npatient,
        pre: { age: preData.age, nihss: preData.nihss, ltsw: preData.ltsw, premrs: preData.premrs },
        trials: trialsForSheet
      };
      sendToSheet(payload);
      alert("Salvato su Google Sheet ✅");
    }

    // Aggiorna il preview quando cambia il patient number
    document.addEventListener('input', (e)=>{
      if (e.target && e.target.id === 'patientNumber') buildShareMessage();
    });

    function copyMessage(){
      const ta = document.getElementById('shareMessage');
      ta.select(); ta.setSelectionRange(0, 99999);
      document.execCommand('copy');
      alert("Message copied to clipboard.");
    }

    function shareWhatsApp(){
      const msg = document.getElementById('shareMessage').value;
      if (!msg || msg.includes("numero paziente")) {
        const ok = confirm("Patient number seems empty. Share anyway?");
        if (!ok) return;
      }
      const url = "https://wa.me/?text=" + encodeURIComponent(msg);
      window.open(url, "_blank");
    }

    function restart(){
      preData = {}; postData = {}; evtData = {}; hemData = {}; lixData = { criteria: {} };
      eligibility = { weTrust:false, athena:false, fastest:false, tich3:false,
                      librexia:false, vanish:false, pivotal:false, moste:false,
                      twin2win2:false, artemis:false, hybernia:false, doneSymple:false };
      selectedStudies = []; studyOutcomes = {};
      for (const k of Object.keys(infoMessages)) infoMessages[k] = "";
      const formPre = document.getElementById('formPreImaging'); if (formPre) formPre.reset();
      const formLib = document.getElementById('formLibrexia'); if (formLib) formLib.reset();
      const shareForm = document.getElementById('shareForm'); if (shareForm) shareForm.reset();
      const container = document.getElementById('studyOutcomesContainer'); if (container) container.innerHTML = "";
      document.getElementById('shareMessage').value = "";
      document.querySelectorAll('.toggle-button').forEach(btn => btn.classList.remove('selected'));
      showPage('mainMenu');
    }
  </script>
</div>
</body>
</html>
